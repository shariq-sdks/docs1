variables:
  IMAGE: gcr.io/authlete/new-api-doc:$CI_COMMIT_SHA

stages:
  - build
  - deploy
  - gen-go-client-master
  - gen-go-client-review
  - delete-go-client-review

build:
  stage: build
  only:
    - master
  script:
    - cd app
    - docker build . -t $IMAGE --build-arg NODE_ENV=production
    - docker push $IMAGE

deploy:
  stage: deploy
  only:
    - master
  script:
    - gcloud config set project authlete
    - gcloud container clusters get-credentials web --zone=us-central1-f
    - kubectl set image deployment/new-api-doc new-api-doc=$IMAGE
    - kubectl rollout status deployment/new-api-doc

gen-go-client-master:
  stage: gen-go-client-master
  only:
    - master
  before_script:
    - mkdir ~/.ssh/
    - echo "${CI_KNOWN_HOSTS}" > ~/.ssh/known_hosts
    - echo "${SSH_PUSH_KEY}" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - git config user.email "ci@authlete.com"
    - git config user.name "CI"
  script:
    - git clone git@github.com:authlete/openapi-for-go.git
    - rm -Rf openapi-for-go/*.go openapi-for-go/go.* openapi-for-go/docs openapi-for-go/api openapi-for-go/.openapi-generator*
    - docker run --rm -v ${PWD}:/local openapitools/openapi-generator-cli batch /local/go-client-codegen.yml
    - cd openapi-for-go
    - git config user.email "ci@authlete.com"
    - git config user.name "CI"
    - git checkout main || true
    - git add .
    - git commit -m "Authlete CI - ${CI_COMMIT_SHA}"
    - git push origin main:refs/heads/main

gen-go-client-review:
  stage: gen-go-client-review
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    on_stop: delete-go-client-review
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: never
    - if: $CI_COMMIT_BRANCH
  before_script:
    - mkdir ~/.ssh/
    - echo "${CI_KNOWN_HOSTS}" > ~/.ssh/known_hosts
    - echo "${SSH_PUSH_KEY}" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - git config user.email "ci@authlete.com"
    - git config user.name "CI"
  script:
    - git clone git@github.com:authlete/openapi-for-go.git
    - rm -Rf openapi-for-go/*.go openapi-for-go/go.* openapi-for-go/docs openapi-for-go/api openapi-for-go/.openapi-generator*
    - docker run --rm -v ${PWD}:/local openapitools/openapi-generator-cli batch /local/go-client-codegen.yml
    - cd openapi-for-go
    - git config user.email "ci@authlete.com"
    - git config user.name "CI"
    - git checkout -b $CI_COMMIT_BRANCH || true
    - git add *.go go.* docs api .openapi-generator*
    - git commit -m "Authlete CI - ${CI_COMMIT_SHA}"
    - git push origin $CI_COMMIT_BRANCH:refs/heads/$CI_COMMIT_BRANCH --force

delete-go-client-review:
  when: manual
  stage: delete-go-client-review
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    action: stop
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: never
    - if: $CI_COMMIT_BRANCH
  before_script:
    - mkdir ~/.ssh/
    - echo "${CI_KNOWN_HOSTS}" > ~/.ssh/known_hosts
    - echo "${SSH_PUSH_KEY}" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - git config user.email "ci@authlete.com"
    - git config user.name "CI"
  script:
    - git clone git@github.com:authlete/openapi-for-go.git
    - cd openapi-for-go
    - git push origin +:refs/heads/$CI_COMMIT_BRANCH


