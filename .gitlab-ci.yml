variables:
  IMAGE: gcr.io/authlete/new-api-doc:$CI_COMMIT_SHA

stages:
  - build
  - deploy
  - build clients

build:
  stage: build
  only:
    - master
  script:
    - cd app
    - docker build . -t $IMAGE --build-arg NODE_ENV=production
    - docker push $IMAGE

deploy:
  stage: deploy
  only:
    - master
  script:
    - gcloud config set project authlete
    - gcloud container clusters get-credentials web --zone=us-central1-f
    - kubectl set image deployment/new-api-doc new-api-doc=$IMAGE
    - kubectl rollout status deployment/new-api-doc

build go client:
  stage: build clients
  trigger:
    include: .gitlab-ci/build-go-client.yml
    strategy: depend
  rules:
    - if: $CI_COMMIT_BRANCH
      changes:
        - specs/**/*
        - go-client-codegen.yml

build go client v3:
  needs: [build go client]
  stage: build clients
  trigger:
    include: .gitlab-ci/build-go-client-v3.yml
    strategy: depend
  rules:
    - if: $CI_COMMIT_BRANCH
      changes:
        - specs/**/*
        - go-client-codegen-v3.yml

build typescript client:
  stage: build clients
  trigger:
    include: .gitlab-ci/build-typescript-client.yml
    strategy: depend
  rules:
    - if: $CI_COMMIT_BRANCH
      changes:
        - specs/**/*
        - typescript-client-codegen.yml